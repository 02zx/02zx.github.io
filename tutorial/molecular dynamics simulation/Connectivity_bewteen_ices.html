<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3 Directed Graph - Labels on Top</title>
    <style>
        /* Styles remain largely the same */
        body {
            font-family: sans-serif;
            margin: 0;
            overflow: hidden;
        }
        svg {
            display: block;
            border: 1px solid lightgray;
            cursor: default;
        }
        .node circle {
            stroke: #0c01019a;
            stroke-width: 0.5px;
        }
        .node text { /* Node labels */
            font-size: 8px;
            fill: #333;
            pointer-events: none;
        }
        .node {
             cursor: pointer;
             transition: opacity 0.3s ease-in-out;
        }
        .link path {
            fill: none;
             transition: opacity 0.3s ease-in-out, stroke 0.3s ease-in-out;
        }
        /* Style for the separate edge labels */
        .edge-label {
            font-size: 5px;
            fill: #000000;
            pointer-events: none; /* Prevent labels from blocking clicks */
            transition: opacity 0.3s ease-in-out;
            paint-order: stroke; /* Draw stroke behind fill for potential background */
            stroke: #ffffff00; /* White background/outline */
            stroke-width: 2px; /* Adjust thickness as needed */
            stroke-linecap: butt;
            stroke-linejoin: miter;
        }
        /* We don't need .link text anymore */
        .link { /* Opacity transition for the link group (which now only contains the path) */
             transition: opacity 0.3s ease-in-out;
        }

    </style>
</head>
<body>
    <svg id="graph-container"></svg>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // --- Configuration ---
        const width = window.innerWidth;
        const height = window.innerHeight;
        const arrowheadSize = 5;
        const nodeRadiusMargin = 0.5;
        const activeOpacity = 1.0;
        const inactiveOpacity = 0.15;
        const incomingEdgeColor = "red";
        const outgoingEdgeColor = "blue";
        const defaultEdgeColor = "#cccccc";

        // --- SVG Setup ---
        const svg = d3.select("#graph-container")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [-width / 2, -height / 2, width, height]);

        const mainG = svg.append("g");

        // --- Arrowhead Marker Definitions ---
        const defs = svg.append("defs");
        // Default Arrowhead
        defs.append("marker").attr("id", "arrowhead-default").attr("viewBox", "0 -5 10 10").attr("refX", arrowheadSize + nodeRadiusMargin).attr("refY", 0).attr("markerWidth", arrowheadSize).attr("markerHeight", arrowheadSize).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#999");
        // Red Arrowhead
        defs.append("marker").attr("id", "arrowhead-red").attr("viewBox", "0 -5 10 10").attr("refX", arrowheadSize + nodeRadiusMargin).attr("refY", 0).attr("markerWidth", arrowheadSize).attr("markerHeight", arrowheadSize).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", incomingEdgeColor);
        // Blue Arrowhead
        defs.append("marker").attr("id", "arrowhead-blue").attr("viewBox", "0 -5 10 10").attr("refX", arrowheadSize + nodeRadiusMargin).attr("refY", 0).attr("markerWidth", arrowheadSize).attr("markerHeight", arrowheadSize).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", outgoingEdgeColor);


        // --- Zoom Handler Setup ---
         const zoomHandler = d3.zoom()
            .scaleExtent([0.1, 8])
            .on("zoom", (event) => {
                mainG.attr("transform", event.transform);
            });
        svg.call(zoomHandler);

        // --- Variables ---
        let nodeGroup, linkGroup, labelGroup; // Add labelGroup
        let validEdges;

        // --- Load Data ---
        const graphData = { /* Your JSON data */
            "nodes": [
    {
      "key": "0",
      "attributes": {
        "label": "Ih",
        "x": 5.3973656,
        "y": -273.35703,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "1",
      "attributes": {
        "label": "Ic",
        "x": -46.767616,
        "y": -227.42131,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "2",
      "attributes": {
        "label": "Isd",
        "x": 4.909236,
        "y": -198.13437,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "3",
      "attributes": {
        "label": "II",
        "x": 31.36678,
        "y": -217.24918,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "4",
      "attributes": {
        "label": "III",
        "x": 73.98561,
        "y": -206.66873,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "5",
      "attributes": {
        "label": "IV",
        "x": -30.77436,
        "y": -105.79443,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "6",
      "attributes": {
        "label": "V",
        "x": 89.29036,
        "y": -157.24414,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "7",
      "attributes": {
        "label": "VI",
        "x": 57.265152,
        "y": -135.13184,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "8",
      "attributes": {
        "label": "VII",
        "x": -0.13813019,
        "y": -117.64861,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "9",
      "attributes": {
        "label": "VIII",
        "x": -34.557205,
        "y": -56.633118,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "10",
      "attributes": {
        "label": "IX",
        "x": 127.58499,
        "y": -187.9911,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "11",
      "attributes": {
        "label": "X",
        "x": -35.11963,
        "y": -23.585266,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "12",
      "attributes": {
        "label": "XI",
        "x": -32.812134,
        "y": -273.95108,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "13",
      "attributes": {
        "label": "XII",
        "x": -23.956446,
        "y": -160.60223,
        "size": 10.0,
        "color": "#389fd6"
      }
    },
    {
      "key": "14",
      "attributes": {
        "label": "XIII",
        "x": 127.10586,
        "y": -146.48193,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "15",
      "attributes": {
        "label": "XIV",
        "x": 8.341257,
        "y": -159.26108,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "16",
      "attributes": {
        "label": "XV",
        "x": 173.6445,
        "y": -110.979904,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "17",
      "attributes": {
        "label": "XVI",
        "x": -203.27173,
        "y": -221.63702,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "18",
      "attributes": {
        "label": "XVII",
        "x": -114.689606,
        "y": -252.23065,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "19",
      "attributes": {
        "label": "XVIII",
        "x": -92.17383,
        "y": -25.135162,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "20",
      "attributes": {
        "label": "XIX",
        "x": 90.33637,
        "y": -108.85134,
        "size": 10.0,
        "color": "#6769e3"
      }
    },
    {
      "key": "21",
      "attributes": {
        "label": "HDA",
        "x": -59.805603,
        "y": -137.59023,
        "size": 10.0,
        "color": "#ccffcc"
      }
    },
    {
      "key": "22",
      "attributes": {
        "label": "LDA",
        "x": -118.03636,
        "y": -137.95764,
        "size": 10.0,
        "color": "#ccffcc"
      }
    },
    {
      "key": "23",
      "attributes": {
        "label": "C0",
        "x": -159.84796,
        "y": -252.94858,
        "size": 10.0,
        "color": "#ffc800"
      }
    },
    {
      "key": "24",
      "attributes": {
        "label": "C2",
        "x": -126.33855,
        "y": -227.07518,
        "size": 10.0,
        "color": "#ffc800"
      }
    },
    {
      "key": "25",
      "attributes": {
        "label": "sII",
        "x": -203.5957,
        "y": -261.10107,
        "size": 10.0,
        "color": "#ffc800"
      }
    }
  ],
  "edges": [
    {
      "key": "6",
      "source": "0",
      "target": "12",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[3]",
        "reference": "null",
        "source name": "Ih",
        "target name": "XI"
      }
    },
    {
      "key": "7",
      "source": "0",
      "target": "3",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[2, 10, 13]",
        "reference": "null",
        "source name": "Ih",
        "target name": "II"
      }
    },
    {
      "key": "8",
      "source": "0",
      "target": "10",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[9, 10]",
        "reference": "null",
        "source name": "Ih",
        "target name": "IX"
      }
    },
    {
      "key": "49",
      "source": "0",
      "target": "4",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[2]",
        "reference": "null",
        "source name": "Ih",
        "target name": "III"
      }
    },
    {
      "key": "10",
      "source": "0",
      "target": "2",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[12]",
        "reference": "null",
        "source name": "Ih",
        "target name": "Isd"
      }
    },
    {
      "key": "11",
      "source": "0",
      "target": "21",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[16]",
        "reference": "null",
        "source name": "Ih",
        "target name": "HDA"
      }
    },
    {
      "key": "12",
      "source": "12",
      "target": "0",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[3]",
        "reference": "null",
        "source name": "XI",
        "target name": "Ih"
      }
    },
    {
      "key": "13",
      "source": "2",
      "target": "0",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[12]",
        "reference": "null",
        "source name": "Isd",
        "target name": "Ih"
      }
    },
    {
      "key": "14",
      "source": "1",
      "target": "0",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "null",
        "reference": "null",
        "source name": "Ic",
        "target name": "Ih"
      }
    },
    {
      "key": "15",
      "source": "3",
      "target": "2",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[12]",
        "reference": "null",
        "source name": "II",
        "target name": "Isd"
      }
    },
    {
      "key": "16",
      "source": "3",
      "target": "4",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[2, 4]",
        "reference": "null",
        "source name": "II",
        "target name": "III"
      }
    },
    {
      "key": "17",
      "source": "3",
      "target": "7",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "II",
        "target name": "VI"
      }
    },
    {
      "key": "18",
      "source": "4",
      "target": "3",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[2, 4]",
        "reference": "null",
        "source name": "III",
        "target name": "II"
      }
    },
    {
      "key": "19",
      "source": "4",
      "target": "10",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[4]",
        "reference": "null",
        "source name": "III",
        "target name": "IX"
      }
    },
    {
      "key": "20",
      "source": "4",
      "target": "6",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[2]",
        "reference": "null",
        "source name": "III",
        "target name": "V"
      }
    },
    {
      "key": "21",
      "source": "6",
      "target": "4",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[2, 13]",
        "reference": "null",
        "source name": "V",
        "target name": "III"
      }
    },
    {
      "key": "22",
      "source": "6",
      "target": "14",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[6]",
        "reference": "null",
        "source name": "V",
        "target name": "XIII"
      }
    },
    {
      "key": "23",
      "source": "6",
      "target": "2",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[12]",
        "reference": "null",
        "source name": "V",
        "target name": "Isd"
      }
    },
    {
      "key": "24",
      "source": "21",
      "target": "6",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[5]",
        "reference": "null",
        "source name": "HDA",
        "target name": "V"
      }
    },
    {
      "key": "25",
      "source": "7",
      "target": "2",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[12]",
        "reference": "null",
        "source name": "VI",
        "target name": "Isd"
      }
    },
    {
      "key": "26",
      "source": "7",
      "target": "16",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[7]",
        "reference": "null",
        "source name": "VI",
        "target name": "XV"
      }
    },
    {
      "key": "27",
      "source": "7",
      "target": "20",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[8]",
        "reference": "null",
        "source name": "VI",
        "target name": "XIX"
      }
    },
    {
      "key": "28",
      "source": "16",
      "target": "7",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[7]",
        "reference": "null",
        "source name": "XV",
        "target name": "VI"
      }
    },
    {
      "key": "29",
      "source": "21",
      "target": "7",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[5]",
        "reference": "null",
        "source name": "HDA",
        "target name": "VI"
      }
    },
    {
      "key": "30",
      "source": "8",
      "target": "9",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[10, 16]",
        "reference": "null",
        "source name": "VII",
        "target name": "VIII"
      }
    },
    {
      "key": "31",
      "source": "21",
      "target": "8",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[10]",
        "reference": "null",
        "source name": "HDA",
        "target name": "VII"
      }
    },
    {
      "key": "32",
      "source": "9",
      "target": "22",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[10]",
        "reference": "null",
        "source name": "VIII",
        "target name": "LDA"
      }
    },
    {
      "key": "33",
      "source": "9",
      "target": "11",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "null",
        "reference": "null",
        "source name": "VIII",
        "target name": "X"
      }
    },
    {
      "key": "34",
      "source": "16",
      "target": "9",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[9, 10]",
        "reference": "null",
        "source name": "XV",
        "target name": "VIII"
      }
    },
    {
      "key": "35",
      "source": "10",
      "target": "2",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[12]",
        "reference": "null",
        "source name": "IX",
        "target name": "Isd"
      }
    },
    {
      "key": "36",
      "source": "10",
      "target": "16",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[9, 10]",
        "reference": "null",
        "source name": "IX",
        "target name": "XV"
      }
    },
    {
      "key": "37",
      "source": "11",
      "target": "19",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[15]",
        "reference": "null",
        "source name": "X",
        "target name": "XVIII"
      }
    },
    {
      "key": "38",
      "source": "13",
      "target": "15",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[6]",
        "reference": "null",
        "source name": "XII",
        "target name": "XIV"
      }
    },
    {
      "key": "39",
      "source": "13",
      "target": "2",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[11]",
        "reference": "null",
        "source name": "XII",
        "target name": "Isd"
      }
    },
    {
      "key": "40",
      "source": "21",
      "target": "13",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[5]",
        "reference": "null",
        "source name": "HDA",
        "target name": "XII"
      }
    },
    {
      "key": "41",
      "source": "21",
      "target": "5",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[5]",
        "reference": "null",
        "source name": "HDA",
        "target name": "IV"
      }
    },
    {
      "key": "42",
      "source": "21",
      "target": "22",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[14]",
        "reference": "null",
        "source name": "HDA",
        "target name": "LDA"
      }
    },
    {
      "key": "43",
      "source": "22",
      "target": "21",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "null",
        "reference": "null",
        "source name": "LDA",
        "target name": "HDA"
      }
    },
    {
      "key": "44",
      "source": "22",
      "target": "2",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[14]",
        "reference": "null",
        "source name": "LDA",
        "target name": "Isd"
      }
    },
    {
      "key": "45",
      "source": "18",
      "target": "1",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "null",
        "reference": "null",
        "source name": "XVII",
        "target name": "Ic"
      }
    },
    {
      "key": "46",
      "source": "23",
      "target": "18",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "null",
        "reference": "null",
        "source name": "C0",
        "target name": "XVII"
      }
    },
    {
      "key": "47",
      "source": "24",
      "target": "1",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "null",
        "reference": "null",
        "source name": "C2",
        "target name": "Ic"
      }
    },
    {
      "key": "48",
      "source": "25",
      "target": "17",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "null",
        "reference": "null",
        "source name": "sII",
        "target name": "XVI"
      }
    },
    {
      "key": "50",
      "source": "3",
      "target": "6",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "II",
        "target name": "V"
      }
    },
    {
      "key": "51",
      "source": "6",
      "target": "7",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "V",
        "target name": "VI"
      }
    },
    {
      "key": "52",
      "source": "7",
      "target": "6",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "VI",
        "target name": "V"
      }
    },
    {
      "key": "53",
      "source": "6",
      "target": "3",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "V",
        "target name": "II"
      }
    },
    {
      "key": "54",
      "source": "3",
      "target": "0",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "II",
        "target name": "Ih"
      }
    },
    {
      "key": "55",
      "source": "4",
      "target": "0",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "III",
        "target name": "Ih"
      }
    },
    {
      "key": "56",
      "source": "7",
      "target": "3",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[13]",
        "reference": "null",
        "source name": "VI",
        "target name": "II"
      }
    },
    {
      "key": "57",
      "source": "8",
      "target": "21",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[14]",
        "reference": "null",
        "source name": "VII",
        "target name": "HDA"
      }
    },
    {
      "key": "58",
      "source": "21",
      "target": "9",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[16]",
        "reference": "null",
        "source name": "HDA",
        "target name": "VIII"
      }
    },
    {
      "key": "59",
      "source": "9",
      "target": "8",
      "attributes": {
        "color": "#cccccc",
        "weight": 1.0,
        "REF": "[16]",
        "reference": "null",
        "source name": "VIII",
        "target name": "VII"
      }
    }
  ]         };

        // --- Data Preprocessing ---
        const nodes = graphData.nodes;
        const edges = graphData.edges;
        const nodeMap = new Map(nodes.map(node => [node.key, node]));
        validEdges = edges.map(edge => ({
            ...edge,
            source: nodeMap.get(edge.source),
            target: nodeMap.get(edge.target)
        })).filter(edge => edge.source && edge.target);
        if (validEdges.length < edges.length) console.warn(`Filtered out ${edges.length - validEdges.length} edge(s) due to missing nodes.`);

        // --- Create Links (Paths Only) --- DRAWN FIRST
        linkGroup = mainG.append("g")
            .attr("class", "links")
            .selectAll("g")
            .data(validEdges, d => d.key)
            .join("g")
            .attr("class", "link"); // This group now just holds the path

        linkGroup.append("path") // Only append the path here
            .attr("stroke", d => d.attributes.color || defaultEdgeColor)
            .attr("stroke-width", d => d.attributes.weight || 1.0)
            .attr("marker-end", "url(#arrowhead-default)")
            .attr("d", d => {
                 const sx = d.source.attributes.x; const sy = d.source.attributes.y;
                 const tx = d.target.attributes.x; const ty = d.target.attributes.y;
                 const dx = tx - sx; const dy = ty - sy;
                 const dist = Math.sqrt(dx * dx + dy * dy);
                 if (dist === 0) return `M${sx},${sy} L${tx},${ty}`;
                 const targetNodeRadius = d.target.attributes.size || 10;
                 const offset = targetNodeRadius + nodeRadiusMargin;
                 const adjTx = tx - (dx / dist) * offset;
                 const adjTy = ty - (dy / dist) * offset;
                 return `M${sx},${sy} L${adjTx},${adjTy}`;
             });
        // === NO TEXT APPENDED TO linkGroup ===

        // --- Create Nodes --- DRAWN SECOND (on top of links)
        nodeGroup = mainG.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(nodes, d => d.key)
            .join("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.attributes.x}, ${d.attributes.y})`)
            .on("click", handleNodeClick);

        nodeGroup.append("circle")
            .attr("r", d => d.attributes.size || 10)
            .attr("fill", d => d.attributes.color || "#ccc");

        nodeGroup.append("text")
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .text(d => d.attributes.label);

        // --- Create Edge Labels --- DRAWN LAST (on top of nodes and links)
        labelGroup = mainG.append("g") // Create the dedicated label group
             .attr("class", "edge-labels") // Add a class for potential styling
             .selectAll("text") // Select the text elements we're about to create
             .data(validEdges, d => d.key) // Bind the same edge data
             .join("text") // Create text elements for each edge
             .attr("class", "edge-label") // Add class for styling
             .attr("x", d => (d.source.attributes.x + 2 * d.target.attributes.x) / 3) // Same positioning logic
             .attr("y", d => (d.source.attributes.y + 2 * d.target.attributes.y) / 3)
             .attr("dy", "-0.3em")
             .attr("text-anchor", "middle")
             .text(d => d.attributes.REF); // Set text content


        // --- Click Handler Functions ---

        function handleNodeClick(event, d) {
            event.stopPropagation();
            const clickedNodeKey = d.key;
            const neighborKeys = new Set([clickedNodeKey]);
            validEdges.forEach(edge => {
                if (edge.source.key === clickedNodeKey) neighborKeys.add(edge.target.key);
                else if (edge.target.key === clickedNodeKey) neighborKeys.add(edge.source.key);
            });

            // Update Node Opacity
            nodeGroup.style("opacity", node_d => neighborKeys.has(node_d.key) ? activeOpacity : inactiveOpacity);

            // Update Link Path Style
            linkGroup.each(function(link_d) {
                const linkElement = d3.select(this);
                const pathElement = linkElement.select("path");
                let targetOpacity = inactiveOpacity;
                let targetStroke = link_d.attributes.color || defaultEdgeColor;
                let targetMarker = "url(#arrowhead-default)";

                if (link_d.target.key === clickedNodeKey) { // Incoming
                    targetOpacity = activeOpacity;
                    targetStroke = incomingEdgeColor;
                    targetMarker = "url(#arrowhead-red)";
                } else if (link_d.source.key === clickedNodeKey) { // Outgoing
                    targetOpacity = activeOpacity;
                    targetStroke = outgoingEdgeColor;
                    targetMarker = "url(#arrowhead-blue)";
                }
                // Apply styles ONLY to the path/link group opacity
                linkElement.style("opacity", targetOpacity); // Fade the path group
                pathElement.attr("stroke", targetStroke)
                           .attr("marker-end", targetMarker);
            });

            // --- Update Label Opacity --- (NEW PART)
            labelGroup.style("opacity", label_d => {
                // Label is visible if the edge is incoming or outgoing from the clicked node
                if (label_d.target.key === clickedNodeKey || label_d.source.key === clickedNodeKey) {
                    return activeOpacity;
                } else {
                    return inactiveOpacity; // Fade labels of unconnected edges
                }
            });
        }

        function resetHighlight() {
             // Reset Nodes
             nodeGroup.style("opacity", activeOpacity);

             // Reset Link Paths
             linkGroup.each(function(link_d) {
                 const linkElement = d3.select(this);
                 const pathElement = linkElement.select("path");
                 linkElement.style("opacity", activeOpacity); // Reset path group opacity
                 pathElement.attr("stroke", link_d.attributes.color || defaultEdgeColor)
                            .attr("marker-end", "url(#arrowhead-default)");
             });

             // --- Reset Label Opacity --- (NEW PART)
             labelGroup.style("opacity", activeOpacity); // Make all labels fully visible
        }

        // Attach click handler to SVG background to reset
        svg.on("click", function(event) {
            if (event.target === this) resetHighlight();
        });

        // Optional Initial View Calculation...
        // function calculateInitialView() { ... }
        // calculateInitialView();

    </script>
</body>
</html>
